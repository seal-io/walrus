package generators

import (
	"os"
	"path/filepath"
	"strings"
	"testing"

	"github.com/stretchr/testify/assert"
	"k8s.io/gengo/args"
	"k8s.io/gengo/generator"

	crdgenargs "github.com/seal-io/code-generator/cmd/crd-gen/args"
)

func Test_crdGen(t *testing.T) {
	var (
		dir = filepath.Join("testdata", "crd_gen")
		pkg = "github.com/seal-io/code-generator/cmd/crd-gen/generators/testdata/crd_gen"
	)

	g := args.GeneratorArgs{
		InputDirs:          []string{pkg},
		OutputBase:         filepath.Join("testdata", "crd_gen"),
		OutputFileBaseName: "zz_generated.crds",
		GoHeaderFilePath:   filepath.Join(dir, "go.txt"),
		GeneratedBuildTag:  "ignore_autogenerated",
		CustomArgs:         &crdgenargs.CustomArgs{},
	}

	err := g.Execute(
		NameSystems(),
		DefaultNameSystem(),
		func(ctx *generator.Context, args *args.GeneratorArgs) generator.Packages {
			packages := Packages(ctx, args)

			for i := range packages {
				p, ok := packages[i].(*generator.DefaultPackage)
				if !ok {
					continue
				}

				p.PackagePath = strings.TrimPrefix(p.PackagePath, pkg)
				packages[i] = p
			}

			return packages
		})
	if err != nil {
		t.Fatalf("failed to execute crd-gen: %v", err)
	}

	actualBytes, err := os.ReadFile(filepath.Join(dir, "zz_generated.crds.go"))
	if err != nil {
		t.Fatalf("failed to read actual file: %v", err)
	}

	expectedBytes, err := os.ReadFile(filepath.Join(dir, "zz_generated.crds.go.expected"))
	if err != nil {
		t.Fatalf("failed to read expected file: %v", err)
	}

	assert.Equal(t, string(expectedBytes), string(actualBytes))
}
